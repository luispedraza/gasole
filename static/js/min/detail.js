var FUEL_OPTIONS={"1":{"short":"G95","name":"Gasolina 95"},"3":{"short":"G98","name":"Gasolina 98"},"4":{"short":"GOA","name":"Gasóleo Automoción"},"5":{"short":"NGO","name":"Nuevo Gasóleo A"},"6":{"short":"GOB","name":"Gasóleo B"},"7":{"short":"GOC","name":"Gasóleo C"},"8":{"short":"BIOD","name":"Biodiésel"}};var FUEL_COLORS={"G95":"#006633","G98":"#339933","GOA":"#000","NGO":"#aaa","GOB":"#CC3333","GOC":"#FF3300","BIOD":"#FFCC33"};function toTitle(s){return s.replace(" [N]","").replace(/^CARRETERA ?|^CR\.? ?/i,"CTRA. ").replace(/(CTRA. )+/i,"CTRA. ").replace(/^AVENIDA ?|^AV. ?/i,"AVDA. ").replace(/^POLIGONO INDUSTRIAL ?|POLIGONO ?|P\.I\. ?/i,"POL. IND. ").replace(/^CALLE |^CL\.? ?|C\/ ?/i,"C/ ").replace(/^RONDA |^RD /i,"RDA. ").replace(/^AUTOPISTA (AUTOPISTA ?)?/i,"AU. ").replace(/^PLAZA ?/i,"PL. ").replace(/^PASEO (PASEO ?)?/i,"Pº ").replace(/^TRAVESS?[IÍ]A /i,"TRAV. ").replace(/^V[ií]A (V[IÍ]A )?/i,"VÍA ").replace(/\B[^\d- ]+[ $]/g,function(t){return t.toLowerCase();}).replace(/\b[NAE]-.+\b/,function(t){return t.toUpperCase();}).replace(/\[D\]$/,"(m.d.)").replace(/\[I\]$/,"(m.i.)").replace(/ \[N\]$/,"");}function getLogo(label){if(label){label=label.replace(/camspa/i,"campsa");logo=label.match(/\b(abycer|agla|alcampo|andamur|a\.?n\.? energeticos|avia|bonarea|b\.?p\.?|buquerin|campsa|carmoned|carrefour|cepsa|empresoil|eroski|esclatoil|galp|gasolben|iberdoex|leclerc|makro|meroil|norpetrol|petrem|petrocat|petromiralles|petronor|repostar|repsol|saras|shell|simply|staroil|tamoil|valcarce)\b/i);if(logo)return logo[0].replace(/\./g,"").replace(/ /g,"_").toLowerCase();}return null;}function decodeName(s){return decodeURI(s).replace(/_/g," ").replace(/\|/g,"/");}function prettyName(s){if(s.match("/"))s=s.split("/")[1];if(s.match(/\)$/))s=s.match(/\(.+\)$/g)[0].replace("(","").replace(")"," ")+s.split(" (")[0];return s;}function decodeArray(a){for(var n=0;n<a.length;n++)a[n]=decodeName(a[n]);return a;}function encodeName(s){return s.replace(/\//g,"|").replace(/ /g,"_");}function checkLocalStorage(){try{return 'localStorage' in window&&window.localStorage!==null;}catch(e){return false;}}var info=null;var LOCAL_EXPIRATION=3600000;var APIS={"gasolineras":"api","resultados":"geo","ficha":"api"};function getApiData(url,key,callback){var req=new XMLHttpRequest();req.onload=function(r){info=JSON.parse(r.target.responseText);console.log("datos obtenidos: ",info);if(key){localStorage.setItem(key,JSON.stringify(info));localStorage.setItem("timestamp",new Date().getTime());}callback(info);};req.open("GET",url);req.send();}function clearCurrentStorage(){if(!checkLocalStorage())return;var pathArray=window.location.pathname.split("/");var option=pathArray[1];if(option=="ficha")localStorage.removeItem(pathArray.slice(2).join("*"));}function getData(callback){var pathArray=window.location.pathname.split("/");var option=pathArray[1];var where1=pathArray[2];var where2=pathArray[3];var key=null;if(checkLocalStorage()){var timestamp=localStorage.timestamp;if(timestamp&&(new Date().getTime()-parseInt(timestamp))>LOCAL_EXPIRATION){console.log("datos antiguos");localStorage.clear();}var storedData=null;if(option=="resultados"){key=where1;storedData=localStorage[key];}else if(option=="gasolineras"){if(where2){key=[where1,where2].join("*");storedData=localStorage[key];if(!storedData)storedData=localStorage[where1];}else{key=where1;storedData=localStorage[key];}}else if(option=="ficha"){var where3=pathArray[4];key=[where1,where2,where3].join("*");storedData=localStorage[key];}if(storedData)info=JSON.parse(storedData);}if(info){if((option=="gasolineras")&&where2){var prov=decodeName(where1);var town=decodeName(where2);tempData={};tempData._data={};tempData._data[prov]={};tempData._data[prov][town]=info._data[prov][town];info=tempData;}console.log("datos recuperados: ",info);callback(info);}else{console.log(key);getApiData(document.URL.replace(option,APIS[option]),key,callback);}return null;}var POINTS=["un asco de lugar","deja mucho que desear","mejor evitarla","las hay mejores","tiene deficiencias","una del montón","está bien en general","por encima de la media","muy recomendable","de las mejores","¡excelente!"];function initMap(latlon){if(!latlon)return;var position=new google.maps.LatLng(latlon[0],latlon[1]);var mapOptions={center:position,zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("google_map"),mapOptions);markerCenter=new google.maps.Marker({map:map,position:position});}function initPoints(){var stars=document.getElementsByClassName("star");document.getElementById("c_points_div").addEventListener("mouseleave",function(){var val=parseInt(document.getElementById("c_points").value);console.log(val);if(!val)document.getElementById("c_points_text").textContent="no olvides asignar una puntuación";else document.getElementById("c_points_text").textContent=POINTS[val];});for(var s=0;s<stars.length;s++){stars[s].addEventListener("mouseover",function(){var id=parseInt(this.id.split("_")[1]);var stars=document.getElementsByClassName("star");for(var s=1;s<stars.length;s++){var _id=parseInt(stars[s].id.split("_")[1]);stars[s].className=stars[s].className.replace(" on","");if(_id<=id)stars[s].className+=" on";}var shit=document.getElementById("star_0");if(id==0)shit.className+=" on";else shit.className=shit.className.replace(" on","");document.getElementById("c_points_text").textContent=POINTS[id];});stars[s].addEventListener("click",function(){var id=this.id.split("_")[1];document.getElementById("c_points").value=parseInt(id);var stars=document.getElementsByClassName("star");for(var s=0;s<stars.length;s++)stars[s].className=stars[s].className.replace(" sel","");this.className+=" sel";});}}function insertLogo(label){var logoid=getLogo(label);if(logoid){var img=document.createElement("img");img.src="/img/logos/"+logoid+"_w.png";document.getElementById("logo").appendChild(img);}else document.getElementById("logo").textContent=label;}function initPrice(price){for(var p in price){var type=FUEL_OPTIONS[p].short;document.getElementById("sec_"+type).style.display="block";document.getElementById("p_"+type).textContent=price[p];}}function fillReplyTo(id){console.log(id);var comment=document.getElementById("comment-"+id);document.getElementById("replyto_name").innerHTML=comment.getElementsByClassName("c_name")[0].textContent.bold();document.getElementById("replyto_msg").innerHTML=comment.getElementsByClassName("c_content")[0].innerHTML;document.getElementById("replyto").style.display="block";document.getElementById("comments").scrollIntoView();document.getElementById("c_replyto").value=id;document.getElementById("section_title").style.display="none";document.getElementById("section_points").style.display="none";document.getElementById("replyto_cancel").addEventListener("click",function(){document.getElementById("replyto").style.display="none";document.getElementById("replyto_name").innerHTML="";document.getElementById("replyto_msg").innerHTML="";document.getElementById("c_replyto").value="";document.getElementById("section_title").style.display="block";document.getElementById("section_points").style.display="block";});}function processData(info){console.log(info);data=info._data;var province,town,station,date,label,hours,latlon,price;for(var p in data)province=p;for(var t in data[p])town=t;for(var s in data[p][t]){station=s;date=data[p][t][s].date;label=data[p][t][s].label;hours=data[p][t][s].hours;latlon=data[p][t][s].latlon;price=data[p][t][s].options;}document.getElementById("address").textContent=toTitle(station)+" ("+town+", "+province+")";document.getElementById("hours").textContent=hours;insertLogo(label);initMap(latlon);initPrice(price);var commentsDiv=document.getElementById("old_comments");var comments=info._comments;var total_points=0;var n_comments=0;for(var c=0;c<comments.length;c++){var newCommentBlock=document.createElement("div");newCommentBlock.className="c_block";newCommentBlock.id="block-"+comments[c].id;var newComment=document.createElement("div");newComment.className="c_comment";newComment.id="comment-"+comments[c].id;if(comments[c].points!=null){var newCPoints=document.createElement("div");var points=parseInt(comments[c].points)/10;var c_points="\""+POINTS[points]+"\" ("+points+"/10)";newCPoints.textContent=c_points;if(points==0)newCPoints.className="c_points_0";else{newCPoints.className="c_points";newCPoints.style.backgroundImage="url('/img/star_"+points+".svg')";}newComment.appendChild(newCPoints);total_points+=points;n_comments++;}var newCName=document.createElement("div");newCName.className="c_name";if(comments[c].link)newCName.innerHTML="<a href='"+comments[c].link+"' rel='external nofollow'>"+comments[c].name+"</a>";else newCName.textContent=comments[c].name;newComment.appendChild(newCName);var newCDate=document.createElement("div");newCDate.className="c_date";newCDate.textContent=new Date(comments[c].date).toLocaleString().split(" ")[0];newComment.appendChild(newCDate);var newCAvatar=document.createElement("img");newCAvatar.className="c_avatar";newCAvatar.src=comments[c].avatar;newComment.appendChild(newCAvatar);if(comments[c].title){var newCTitle=document.createElement("div");newCTitle.className="c_title";newCTitle.textContent=comments[c].title;newComment.appendChild(newCTitle);}var newCContent=document.createElement("div");newCContent.className="c_content";newCContent.innerHTML=comments[c].content.replace(/\n/g,"<br>");newComment.appendChild(newCContent);var newCReply=document.createElement("div");newCReply.textContent="responder…";newCReply.className="reply_btn";newCReply.id="replyto-"+comments[c].id;newCReply.addEventListener("click",function(e){var id=this.id.split("-")[1];fillReplyTo(id);});newComment.appendChild(newCReply);newCommentBlock.appendChild(newComment);var newCReplies=document.createElement("div");newCReplies.id="replies-"+comments[c].id;newCReplies.className="replies";newCommentBlock.appendChild(newCReplies);if(comments[c].replyto)document.getElementById("replies-"+comments[c].replyto).appendChild(newCommentBlock);else commentsDiv.appendChild(newCommentBlock);}if(document.getElementById("c_replyto").value)fillReplyTo(document.getElementById("c_replyto").value);document.getElementById("c_link").addEventListener("click",function(){if(this.value=="")this.value="http://";});document.getElementById("c_link").addEventListener("blur",function(){if(this.value=="http://")this.value="";});if(total_points!=0){var points=total_points/n_comments;document.getElementById("points").innerHTML=points.toFixed(1)+" ("+n_comments+" valoraciones)";}var chart_data=new google.visualization.DataTable();chart_data.addColumn('date','Fecha');var chart_colors=[];var history=info._history;var init=false;for(var h in history){if(!init){for(var o in history[h]){chart_data.addColumn('number',o);chart_colors.push(FUEL_COLORS[o]);}init=true;}var date=h.split("-");var values=[];for(var o in history[h])values.push(history[h][o]);chart_data.addRows([[new Date(date[0],date[1]-1,date[2])].concat(values)]);}chart_data.sort(0);var options={title:'Precios',theme:'maximized',pointSize:5,colors:chart_colors};var chart=new google.visualization.LineChart(document.getElementById('chart'));chart.draw(chart_data,options);initPoints();if(document.getElementById("error_list"))document.getElementById("comments").scrollIntoView();document.getElementById("send_comment").addEventListener("click",function(){clearCurrentStorage();});}window.addEventListener("load",function(){getData(processData);});